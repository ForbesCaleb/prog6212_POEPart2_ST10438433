@using System.Security.Claims
@using POE_Part2_PROG6212.Models
@{
    ViewData["Title"] = "Dashboard";
    var role = User.FindFirst(ClaimTypes.Role)?.Value ?? "";
    var name = User.Identity?.Name ?? "User";

    // role theme
    string accent = role switch
    {
        "Lecturer" => "#5e60ce",   // purple
        "ProgrammeCoordinator" => "#0ea5e9",   // sky
        "AcademicManager" => "#22c55e",   // green
        _ => "#0d6efd"    // default
    };
    string emoji = role switch
    {
        "Lecturer" => "🎓",
        "ProgrammeCoordinator" => "🗂️",
        "AcademicManager" => "📈",
        _ => "✨"
    };

    var recent = ViewBag.RecentClaims as IReadOnlyList<ClaimDto>;
}

@section Styles {
    <style>
        :root {
            --accent: @accent;
        }

        .hero {
            background: linear-gradient(135deg, var(--accent) 0%, #0f172a 100%);
            color: #fff;
            border-radius: 1rem;
            padding: 2rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.12);
        }

            .hero h1 {
                font-weight: 800;
                letter-spacing: .2px;
            }

        .card-hover {
            transition: transform .12s ease, box-shadow .12s ease;
        }

            .card-hover:hover {
                transform: translateY(-3px);
                box-shadow: 0 .75rem 1.5rem rgba(0,0,0,.08);
            }

        .pill {
            display: inline-block;
            padding: .25rem .6rem;
            border-radius: 999px;
            background: #fff2;
            color: #fff;
        }

        .badge-soft {
            background: #eef2ff;
            color: #3730a3;
        }

        .progress-slim {
            height: 8px;
        }
    </style>
}

<div class="hero">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div>
            <div class="pill mb-2">@role</div>
            <h1 class="mb-1">@emoji Welcome, @name</h1>
            <div class="text-white-50">Your role-specific shortcuts and insights are below.</div>
        </div>
        <div class="text-end">
            <a asp-controller="Auth" asp-action="Logout" class="btn btn-light">Logout</a>
        </div>
    </div>
</div>

@if (role == "Lecturer")
{
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <a asp-controller="Dashboard" asp-action="SubmitClaim" class="text-decoration-none">
                <div class="card card-hover h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3 fs-3">📝</div>
                            <div>
                                <h5 class="mb-1">Submit Claim</h5>
                                <div class="text-muted small">Capture date, hours, rate and upload a document.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6">
            <a asp-controller="Dashboard" asp-action="MyClaims" class="text-decoration-none">
                <div class="card card-hover h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3 fs-3">📦</div>
                            <div>
                                <h5 class="mb-1">My Claims</h5>
                                <div class="text-muted small">Filter, search and track approval status.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    @if (recent != null && recent.Any())
    {
        <div class="card">
            <div class="card-header bg-white fw-semibold">Recent Claims</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Activity</th>
                                <th>Hours</th>
                                <th>Rate (R)</th>
                                <th>Total (R)</th>
                                <th>Status</th>
                                <th style="min-width:160px;">Progress</th>
                                <th>Docs</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in recent)
                            {
                                var percent = c.Status == ClaimStatus.Submitted ? 33 :
                                c.Status == ClaimStatus.UnderReview ? 66 : 100;
                                var bar = c.Status == ClaimStatus.Approved ? "bg-success" :
                                c.Status == ClaimStatus.Rejected ? "bg-danger" : "bg-info";
                                <tr>
                                    <td>@c.DateWorked:yyyy-MM-dd</td>
                                    <td>@c.Activity</td>
                                    <td>@c.HoursWorked</td>
                                    <td>@c.HourlyRate.ToString("N2")</td>
                                    <td>@c.TotalAmount.ToString("N2")</td>
                                    <td><span class="badge @(c.Status == ClaimStatus.Approved ? "bg-success" : (c.Status == ClaimStatus.Rejected ? "bg-danger" : "bg-secondary"))">@c.Status</span></td>
                                    <td>
                                        <div class="progress progress-slim">
                                            <div class="progress-bar @bar" style="width:@percent%"></div>
                                        </div>
                                    </td>
                                    <td>
                                        @if (c.Documents?.Any() ?? false)
                                        {
                                            foreach (var d in c.Documents)
                                            {
                                                <a href="@d.RelativePath" target="_blank">@d.FileName</a>
                                                <br />
                 }
            }
                                        else
                                        {
                                            <span class="text-muted">None</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
}
else if (role == "ProgrammeCoordinator")
{
    <div class="row g-3">
        <div class="col-md-6">
            <a asp-controller="Management" asp-action="ReviewClaims" class="text-decoration-none">
                <div class="card card-hover h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3 fs-3">🗂️</div>
                            <div>
                                <h5 class="mb-1">Review Pending Claims</h5>
                                <div class="text-muted small">Start review, approve or reject with comments.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6">
            <a asp-controller="Management" asp-action="ReviewClaims" class="text-decoration-none">
                <div class="card card-hover h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3 fs-3">🔎</div>
                            <div>
                                <h5 class="mb-1">Search & Filter</h5>
                                <div class="text-muted small">Find claims by lecturer, date or status.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
}
else if (role == "AcademicManager")
{
    <div class="row g-3">
        <div class="col-md-6">
            <a asp-controller="Management" asp-action="ReviewClaims" class="text-decoration-none">
                <div class="card card-hover h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3 fs-3">📈</div>
                            <div>
                                <h5 class="mb-1">Manage Approvals</h5>
                                <div class="text-muted small">Final decisions with full audit notes.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6">
            <a asp-controller="Dashboard" asp-action="MyClaims" class="text-decoration-none">
                <div class="card card-hover h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3 fs-3">📊</div>
                            <div>
                                <h5 class="mb-1">Overview</h5>
                                <div class="text-muted small">Quick glance of trends and throughput.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
}
else
{
    <div class="alert alert-info">Your role is not recognized. Please contact an administrator.</div>
}


